"use client"

import { createContext, useContext, useEffect, useState } from "react"

/**
 * @typedef {Object} User
 * @property {string} id
 * @property {string} username
 * @property {string} email
 * @property {string} first_name
 * @property {string} last_name
 * @property {string} [bio]
 * @property {string} [profile_picture]
 * @property {string} role
 * @property {boolean} verified
 */

/**
 * @typedef {Object} AuthContextType
 * @property {User|null} user
 * @property {boolean} isLoading
 * @property {boolean} isAuthenticated
 * @property {function(string, string): Promise<void>} login
 * @property {function(): void} logout
 * @property {function(Partial<User>): Promise<void>} updateUser
 */

const AuthContext = createContext(undefined)

/**
 * Authentication context provider
 * @param {Object} props
 * @param {React.ReactNode} props.children
 */
export function AuthProvider({ children }) {
  const [user, setUser] = useState(null)
  const [isLoading, setIsLoading] = useState(true)

  const isAuthenticated = !!user

  useEffect(() => {
    const initAuth = async () => {
      const token = localStorage.getItem("token")
      if (token) {
        try {
          const res = await fetch("https://admin.ilkin.site/api/auth/profile/", {
            headers: {
              Authorization: `Token ${token}`,
            },
          })
          if (res.ok) {
            const userData = await res.json()
            console.log("User data loaded:", userData)
            setUser(userData)
          } else {
            console.log("Token invalid, removing from storage")
            localStorage.removeItem("token")
            localStorage.removeItem("refresh")
          }
        } catch (error) {
          console.error("Error loading user:", error)
          localStorage.removeItem("token")
          localStorage.removeItem("refresh")
        }
      }
      setIsLoading(false)
    }

    initAuth()
  }, [])

  const parseErrorMessage = (responseData) => {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª–µ–π
    if (responseData.non_field_errors && Array.isArray(responseData.non_field_errors)) {
      return responseData.non_field_errors[0]
    }
    if (responseData.detail) {
      return responseData.detail
    }
    if (responseData.message) {
      return responseData.message
    }
    if (responseData.error) {
      return responseData.error
    }
    if (responseData.errors) {
      // –ï—Å–ª–∏ errors —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏
      if (typeof responseData.errors === "object") {
        const firstError = Object.values(responseData.errors)[0]
        if (Array.isArray(firstError)) {
          return firstError[0]
        }
        return firstError
      }
      return responseData.errors
    }
    return null
  }

  const testServerConnection = async () => {
    try {
      console.log("üîç Testing server connection...")

      // –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
      const response = await fetch("https://admin.ilkin.site/api/", {
        method: "GET",
        mode: "cors",
        headers: {
          Accept: "application/json",
        },
      })

      console.log("‚úÖ Server connection test:", {
        status: response.status,
        ok: response.ok,
        headers: Object.fromEntries(response.headers.entries()),
      })

      return { connected: true, status: response.status }
    } catch (error) {
      console.error("‚ùå Server connection failed:", error)
      return { connected: false, error: error.message }
    }
  }

  const makeRequest = async (url, options, retries = 2) => {
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        console.log(`üîÑ Attempt ${attempt + 1}/${retries + 1} for ${url}`)

        const response = await fetch(url, {
          ...options,
          mode: "cors",
          credentials: "omit", // –£–±–∏—Ä–∞–µ–º credentials –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞
          headers: {
            ...options.headers,
            Accept: "application/json",
            "User-Agent": "C-News-App/1.0",
          },
        })

        console.log(`üì° Response from ${url}:`, {
          status: response.status,
          ok: response.ok,
          statusText: response.statusText,
          headers: Object.fromEntries(response.headers.entries()),
        })

        return response
      } catch (error) {
        console.error(`‚ùå Request attempt ${attempt + 1} failed:`, error)

        if (attempt === retries) {
          // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
          throw new Error(`Network request failed after ${retries + 1} attempts: ${error.message}`)
        }

        // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        await new Promise((resolve) => setTimeout(resolve, 1000 * (attempt + 1)))
      }
    }
  }

  const login = async (username, password) => {
    console.log("üöÄ Starting login process for:", username)

    // –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
    const connectionTest = await testServerConnection()
    if (!connectionTest.connected) {
      throw new Error(
        `Cannot connect to server: ${connectionTest.error}. Please check your internet connection or try again later.`,
      )
    }

    // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã API endpoints –∏ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö
    const loginVariants = [
      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
      {
        name: "Standard login with username",
        url: "https://admin.ilkin.site/api/auth/login/",
        body: { username, password },
        headers: { "Content-Type": "application/json" },
      },
      {
        name: "Standard login with email",
        url: "https://admin.ilkin.site/api/auth/login/",
        body: { email: username, password },
        headers: { "Content-Type": "application/json" },
      },
      // Django REST Framework –≤–∞—Ä–∏–∞–Ω—Ç—ã
      {
        name: "DRF Token auth",
        url: "https://admin.ilkin.site/api/auth/token/",
        body: { username, password },
        headers: { "Content-Type": "application/json" },
      },
      {
        name: "Simple token endpoint",
        url: "https://admin.ilkin.site/api/token/",
        body: { username, password },
        headers: { "Content-Type": "application/json" },
      },
      // Dj-rest-auth –≤–∞—Ä–∏–∞–Ω—Ç—ã
      {
        name: "Dj-rest-auth with username",
        url: "https://admin.ilkin.site/api/dj-rest-auth/login/",
        body: { username, password },
        headers: { "Content-Type": "application/json" },
      },
      {
        name: "Dj-rest-auth with email",
        url: "https://admin.ilkin.site/api/dj-rest-auth/login/",
        body: { email: username, password },
        headers: { "Content-Type": "application/json" },
      },
      // Form data –≤–∞—Ä–∏–∞–Ω—Ç—ã
      {
        name: "Form data login",
        url: "https://admin.ilkin.site/api/auth/login/",
        body: new URLSearchParams({ username, password }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
      },
    ]

    let lastError = null
    const detailedErrors = []
    const credentialsErrors = []
    const networkErrors = []

    for (const [index, variant] of loginVariants.entries()) {
      try {
        console.log(`\nüîÑ Trying variant ${index + 1}: ${variant.name}`)
        console.log(`üì° URL: ${variant.url}`)
        console.log(`üì¶ Body:`, variant.body)
        console.log(`üìã Headers:`, variant.headers)

        const requestOptions = {
          method: "POST",
          headers: variant.headers,
          body: variant.headers["Content-Type"] === "application/json" ? JSON.stringify(variant.body) : variant.body,
        }

        const res = await makeRequest(variant.url, requestOptions)

        // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        const responseText = await res.text()
        console.log(`üìÑ Response text:`, responseText)

        let responseData = {}
        try {
          responseData = JSON.parse(responseText)
        } catch (e) {
          console.log("‚ö†Ô∏è Response is not JSON:", responseText)
          responseData = { rawText: responseText }
        }

        if (res.ok) {
          console.log("‚úÖ Login successful with variant", index + 1)
          console.log("üìä Response data:", responseData)

          // –ò—â–µ–º —Ç–æ–∫–µ–Ω –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—è—Ö
          const token =
            responseData.token ||
            responseData.access ||
            responseData.access_token ||
            responseData.key ||
            responseData.auth_token

          if (token) {
            localStorage.setItem("token", token)
            console.log("üíæ Token saved:", token.substring(0, 10) + "...")

            if (responseData.refresh || responseData.refresh_token) {
              localStorage.setItem("refresh", responseData.refresh || responseData.refresh_token)
            }

            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserProfile(token)
            return // –£—Å–ø–µ—à–Ω—ã–π –ª–æ–≥–∏–Ω
          } else {
            console.log("‚ö†Ô∏è No token found in response")
            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, –Ω–æ –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –¥—Ä—É–≥–æ–π —Ç–∏–ø –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            if (responseData.user) {
              setUser(responseData.user)
              return
            }
          }
        } else {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
          const errorMessage = parseErrorMessage(responseData)

          detailedErrors.push({
            variant: index + 1,
            variantName: variant.name,
            url: variant.url,
            status: res.status,
            statusText: res.statusText,
            body: responseData,
            errorMessage,
            rawResponse: responseText,
          })

          console.log(`‚ùå Variant ${index + 1} failed:`, {
            status: res.status,
            statusText: res.statusText,
            body: responseData,
            errorMessage,
          })

          // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
          if (
            errorMessage &&
            (errorMessage.toLowerCase().includes("unable to log in") ||
              errorMessage.toLowerCase().includes("invalid credentials") ||
              errorMessage.toLowerCase().includes("incorrect username") ||
              errorMessage.toLowerCase().includes("incorrect password"))
          ) {
            credentialsErrors.push({
              variant: index + 1,
              variantName: variant.name,
              url: variant.url,
              message: errorMessage,
            })
          }

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É
          lastError = new Error(errorMessage || `HTTP ${res.status}`)
        }
      } catch (error) {
        console.error(`üí• Network error with variant ${index + 1}:`, error)

        networkErrors.push({
          variant: index + 1,
          variantName: variant.name,
          url: variant.url,
          error: error.message,
          type: error.name,
        })

        detailedErrors.push({
          variant: index + 1,
          variantName: variant.name,
          url: variant.url,
          error: error.message,
          type: "NetworkError",
        })

        lastError = error
      }
    }

    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log("\nüìä Login attempt summary:")
    console.table(detailedErrors)

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∏ –¥–∞—ë–º –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (networkErrors.length === loginVariants.length) {
      console.log("üåê All requests failed with network errors:", networkErrors)
      throw new Error("Cannot connect to the server. Please check your internet connection and try again.")
    }

    if (credentialsErrors.length > 0) {
      console.log("üîê Credentials errors found:", credentialsErrors)
      throw new Error("Invalid username or password. Please check your credentials and try again.")
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
    const has400Errors = detailedErrors.some((e) => e.status === 400)
    const has401Errors = detailedErrors.some((e) => e.status === 401)
    const has404Errors = detailedErrors.some((e) => e.status === 404)
    const has405Errors = detailedErrors.some((e) => e.status === 405)

    if (has401Errors) {
      throw new Error("Authentication failed. Please check your username and password.")
    } else if (has400Errors) {
      const error400 = detailedErrors.find((e) => e.status === 400)
      const errorMsg = error400.errorMessage || "Bad request"
      throw new Error(`Request error: ${errorMsg}`)
    } else if (has404Errors) {
      throw new Error("Login service not found. Please contact support.")
    } else if (has405Errors) {
      throw new Error("Login method not supported. Please contact support.")
    } else {
      throw lastError || new Error("Login failed - no working endpoints found")
    }
  }

  const loadUserProfile = async (token) => {
    const profileEndpoints = [
      "https://admin.ilkin.site/api/auth/profile/",
      "https://admin.ilkin.site/api/auth/user/",
      "https://admin.ilkin.site/api/user/",
      "https://admin.ilkin.site/api/users/me/",
      "https://admin.ilkin.site/api/profile/",
    ]

    for (const endpoint of profileEndpoints) {
      try {
        console.log(`üë§ Trying to load profile from: ${endpoint}`)

        const res = await makeRequest(endpoint, {
          method: "GET",
          headers: {
            Authorization: `Token ${token}`,
          },
        })

        console.log(`üë§ Profile response status: ${res.status}`)

        if (res.ok) {
          const userData = await res.json()
          console.log("‚úÖ User profile loaded:", userData)
          setUser(userData)
          return
        }
      } catch (error) {
        console.error(`‚ùå Error loading profile from ${endpoint}:`, error)
      }
    }

    console.log("‚ö†Ô∏è Could not load user profile, but login was successful")
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    setUser({ username: "User", email: "", authenticated: true })
  }

  const logout = () => {
    localStorage.removeItem("token")
    localStorage.removeItem("refresh")
    setUser(null)
  }

  const updateUser = async (userData) => {
    const token = localStorage.getItem("token")
    if (!token) throw new Error("Not authenticated")

    const res = await fetch("https://admin.ilkin.site/api/auth/profile/", {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Token ${token}`,
      },
      body: JSON.stringify(userData),
    })

    if (!res.ok) {
      throw new Error("Failed to update profile")
    }

    const updatedUser = await res.json()
    console.log("User data after update:", updatedUser)
    setUser(updatedUser)
  }

  return (
    <AuthContext.Provider
      value={{
        user,
        isLoading,
        isAuthenticated,
        login,
        logout,
        updateUser,
      }}
    >
      {children}
    </AuthContext.Provider>
  )
}

/**
 * Hook to use authentication context
 * @returns {AuthContextType}
 */
export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error("useAuth must be used within an AuthProvider")
  }
  return context
}
